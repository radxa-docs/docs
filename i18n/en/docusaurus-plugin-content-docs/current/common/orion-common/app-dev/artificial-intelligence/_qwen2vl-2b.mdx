**Qwen2-VL** is an open-source multimodal vision-language model series developed by Alibaba Cloud's Tongyi Qianwen team. This series achieves deep fusion between unified visual encoders and large language model foundations, aiming to provide powerful image understanding, fine-grained reasoning, and open-world dialogue capabilities.

- **Key Features**: The series models generally possess efficient visual-semantic alignment capabilities, supporting precise image content description, complex Q&A, logical reasoning, and multi-turn interactions. Their architecture balances performance and efficiency, showing broad application potential in document analysis, intelligent assistants, and multimodal search scenarios.
- **Version Note**: This model Qwen2-VL-2B-Instruct is a lightweight practice version of the series with approximately 2 billion parameters, optimized through instruction fine-tuning for deployment in edge and low-resource environments, enabling real-time multimodal interaction.

## Environment Setup

Refer to the [llama.cpp](../../../../orion/o6/app-development/artificial-intelligence/llama_cpp.md) documentation to prepare the llama.cpp tools.

## Quick Start

### Download Model

<NewCodeBlock tip="O6 / O6N" type="device">

```bash
pip3 install modelscope
cd llama.cpp
modelscope download --model radxa/Qwen2-VL-2B-Instruct-NOE mmproj-Qwen2-VL-2b-Instruct-F16.gguf --local_dir ./
modelscope download --model radxa/Qwen2-VL-2B-Instruct-NOE Qwen2-VL-2B-Instruct-Q5_K_M.gguf --local_dir ./
modelscope download --model radxa/Qwen2-VL-2B-Instruct-NOE test.png --local_dir ./
```

</NewCodeBlock>

### Run Model

<NewCodeBlock tip="O6 / O6N" type="device">

```bash
./build/bin/llama-mtmd-cli -m ./Qwen2-VL-2B-Instruct-Q5_K_M.gguf --mmproj ./mmproj-Qwen2-VL-2b-Instruct-F16.gguf -p "Describe this image." --image ./test.png
```

</NewCodeBlock>

## Complete Conversion Workflow

### Clone Model Repository

<NewCodeBlock tip="O6 / O6N" type="device">

```bash
cd llama.cpp
git clone https://huggingface.co/Qwen/Qwen2-VL-2B-Instruct
```

</NewCodeBlock>

### Create Virtual Environment

<NewCodeBlock tip="O6 / O6N" type="device">

```bash
python3 -m venv .venv
source .venv/bin/activate
pip3 install -r requirements.txt
```

</NewCodeBlock>

### Model Conversion

#### Convert Text Module

<NewCodeBlock tip="O6 / O6N" type="device">

```bash
python3 ./convert_hf_to_gguf.py ./Qwen2-VL-2B-Instruct
```

</NewCodeBlock>

#### Convert Vision Module

<NewCodeBlock tip="O6 / O6N" type="device">

```bash
python3 ./convert_hf_to_gguf.py --mmproj ./Qwen2-VL-2B-Instruct
```

</NewCodeBlock>

### Model Quantization

Here we use Q5_K_M quantization.

<NewCodeBlock tip="O6 / O6N" type="device">

```bash
./build/bin/llama-quantize ./Qwen2-VL-2B-Instruct/Qwen2-VL-2B-Instruct-F16.gguf ./Qwen2-VL-2B-Instruct/Qwen2-VL-2B-Instruct-Q5_K_M.gguf Q5_K_M
```

</NewCodeBlock>

### Model Test

<div className="image-container" style={{ textAlign: "center" }}>
  <img
    src="/en/img/orion/o6/ai-models/sd-npu.webp"
    height="300"
    style={{ display: "block", margin: "0 auto" }}
  />
  <div className="image-caption" style={{ marginTop: "8px" }}>
    Model test input
  </div>
</div>

<NewCodeBlock tip="O6 / O6N" type="device">

```bash
./build/bin/llama-mtmd-cli -m ./Qwen2-VL-2B-Instruct/Qwen2-VL-2B-Instruct-Q5_K_M.gguf --mmproj ./Qwen2-VL-2B-Instruct/mmproj-Qwen2-VL-2b-Instruct-F16.gguf -p "Describe this image." --image ./Qwen2-VL-2B-Instruct/test.png
```

</NewCodeBlock>

Model output:

```bash
$ ./build/bin/llama-mtmd-cli -m ./Qwen2-VL-2B-Instruct/Qwen2-VL-2B-Instruct-Q5_K_M.gguf --mmproj ./Qwen2-VL-2B-Instruct/mmproj-Qwen
2-VL-2b-Instruct-F16.gguf -p "Describe this image." --image ./Qwen2-VL-2B-Instruct/test.png
build: 7110 (3ae282a06) with cc (Debian 12.2.0-14+deb12u1) 12.2.0 for aarch64-linux-gnu
llama_model_loader: loaded meta data with 33 key-value pairs and 338 tensors from ./Qwen2-VL-2B-Instruct/Qwen2-VL-2B-Instruct-Q5_K_M.gguf (version GGUF V3 (latest))
llama_model_loader: Dumping metadata keys/values. Note: KV overrides do not apply in this output.
llama_model_loader: - kv   0:                       general.architecture str              = qwen2vl
llama_model_loader: - kv   1:                               general.type str              = model
llama_model_loader: - kv   2:                               general.name str              = Qwen2 VL 2B Instruct
llama_model_loader: - kv   3:                           general.finetune str              = Instruct
llama_model_loader: - kv   4:                           general.basename str              = Qwen2-VL
llama_model_loader: - kv   5:                         general.size_label str              = 2B
llama_model_loader: - kv   6:                            general.license str              = apache-2.0
llama_model_loader: - kv   7:                   general.base_model.count u32              = 1
llama_model_loader: - kv   8:                  general.base_model.0.name str              = Qwen2 VL 2B
llama_model_loader: - kv   9:          general.base_model.0.organization str              = Qwen
llama_model_loader: - kv  10:              general.base_model.0.repo_url str              = https://huggingface.co/Qwen/Qwen2-VL-2B
llama_model_loader: - kv  11:                               general.tags arr[str,2]       = ["multimodal", "image-text-to-text"]
llama_model_loader: - kv  12:                          general.languages arr[str,1]       = ["en"]
llama_model_loader: - kv  13:                        qwen2vl.block_count u32              = 28
llama_model_loader: - kv  14:                     qwen2vl.context_length u32              = 32768
llama_model_loader: - kv  15:                   qwen2vl.embedding_length u32              = 1536
llama_model_loader: - kv  16:                qwen2vl.feed_forward_length u32              = 8960
llama_model_loader: - kv  17:               qwen2vl.attention.head_count u32              = 12
llama_model_loader: - kv  18:            qwen2vl.attention.head_count_kv u32              = 2
llama_model_loader: - kv  19:                     qwen2vl.rope.freq_base f32              = 1000000.000000
llama_model_loader: - kv  20:   qwen2vl.attention.layer_norm_rms_epsilon f32              = 0.000001
llama_model_loader: - kv  21:            qwen2vl.rope.dimension_sections arr[i32,4]       = [16, 24, 24, 0]
llama_model_loader: - kv  22:                       tokenizer.ggml.model str              = gpt2
llama_model_loader: - kv  23:                         tokenizer.ggml.pre str              = qwen2
llama_model_loader: - kv  24:                      tokenizer.ggml.tokens arr[str,151936]  = ["!", "\"", "#", "$", "%", "&", "'", ...
llama_model_loader: - kv  25:                  tokenizer.ggml.token_type arr[i32,151936]  = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
llama_model_loader: - kv  26:                      tokenizer.ggml.merges arr[str,151387]  = ["Ġ Ġ", "ĠĠ ĠĠ", "i n", "Ġ t",...
llama_model_loader: - kv  27:                tokenizer.ggml.eos_token_id u32              = 151645
llama_model_loader: - kv  28:            tokenizer.ggml.padding_token_id u32              = 151643
llama_model_loader: - kv  29:                tokenizer.ggml.bos_token_id u32              = 151643
llama_model_loader: - kv  30:                    tokenizer.chat_template str              = {% set image_count = namespace(value=...
llama_model_loader: - kv  31:               general.quantization_version u32              = 2
llama_model_loader: - kv  32:                          general.file_type u32              = 17
llama_model_loader: - type  f32:  141 tensors
llama_model_loader: - type q5_K:  168 tensors
llama_model_loader: - type q6_K:   29 tensors
print_info: file format = GGUF V3 (latest)
print_info: file type   = Q5_K - Medium
print_info: file size   = 1.04 GiB (5.80 BPW)
load: printing all EOG tokens:
load:   - 151643 ('<|endoftext|>')
load:   - 151645 ('<|im_end|>')
load: special tokens cache size = 14
load: token to piece cache size = 0.9309 MB
print_info: arch             = qwen2vl
print_info: vocab_only       = 0
print_info: n_ctx_train      = 32768
print_info: n_embd           = 1536
print_info: n_embd_inp       = 1536
print_info: n_layer          = 28
print_info: n_head           = 12
print_info: n_head_kv        = 2
print_info: n_rot            = 128
print_info: n_swa            = 0
print_info: is_swa_any       = 0
print_info: n_embd_head_k    = 128
print_info: n_embd_head_v    = 128
print_info: n_gqa            = 6
print_info: n_embd_k_gqa     = 256
print_info: n_embd_v_gqa     = 256
print_info: f_norm_eps       = 0.0e+00
print_info: f_norm_rms_eps   = 1.0e-06
print_info: f_clamp_kqv      = 0.0e+00
print_info: f_max_alibi_bias = 0.0e+00
print_info: f_logit_scale    = 0.0e+00
print_info: f_attn_scale     = 0.0e+00
print_info: n_ff             = 8960
print_info: n_expert         = 0
print_info: n_expert_used    = 0
print_info: n_expert_groups  = 0
print_info: n_group_used     = 0
print_info: causal attn      = 1
print_info: pooling type     = -1
print_info: rope type        = 8
print_info: rope scaling     = linear
print_info: freq_base_train  = 1000000.0
print_info: freq_scale_train = 1
print_info: n_ctx_orig_yarn  = 32768
print_info: rope_finetuned   = unknown
print_info: mrope sections   = [16, 24, 24, 0]
print_info: model type       = 1.5B
print_info: model params     = 1.54 B
print_info: general.name     = Qwen2 VL 2B Instruct
print_info: vocab type       = BPE
print_info: n_vocab          = 151936
print_info: n_merges         = 151387
print_info: BOS token        = 151643 '<|endoftext|>'
print_info: EOS token        = 151645 '<|im_end|>'
print_info: EOT token        = 151645 '<|im_end|>'
print_info: PAD token        = 151643 '<|endoftext|>'
print_info: LF token         = 198 'Ċ'
print_info: EOG token        = 151643 '<|endoftext|>'
print_info: EOG token        = 151645 '<|im_end|>'
print_info: max token length = 256
load_tensors: loading model tensors, this can take a while... (mmap = true)
load_tensors:   CPU_Mapped model buffer size =  1067.26 MiB
....................................................................................
llama_context: constructing llama_context
llama_context: n_seq_max     = 1
llama_context: n_ctx         = 4096
llama_context: n_ctx_seq     = 4096
llama_context: n_batch       = 2048
llama_context: n_ubatch      = 512
llama_context: causal_attn   = 1
llama_context: flash_attn    = auto
llama_context: kv_unified    = false
llama_context: freq_base     = 1000000.0
llama_context: freq_scale    = 1
llama_context: n_ctx_seq (4096) < n_ctx_train (32768) -- the full capacity of the model will not be utilized
llama_context:        CPU  output buffer size =     0.58 MiB
llama_kv_cache:        CPU KV buffer size =   112.00 MiB
llama_kv_cache: size =  112.00 MiB (  4096 cells,  28 layers,  1/1 seqs), K (f16):   56.00 MiB, V (f16):   56.00 MiB
llama_context: Flash Attention was auto, set to enabled
llama_context:        CPU compute buffer size =   302.75 MiB
llama_context: graph nodes  = 959
llama_context: graph splits = 1
common_init_from_params: added <|endoftext|> logit bias = -inf
common_init_from_params: added <|im_end|> logit bias = -inf
common_init_from_params: setting dry_penalty_last_n to ctx_size = 4096
common_init_from_params: warming up the model with an empty run - please wait ... (--no-warmup to disable)
mtmd_cli_context: chat template example:
<|im_start|>system
You are a helpful assistant<|im_end|>
<|im_start|>user
Hello<|im_end|>
<|im_start|>assistant
Hi there<|im_end|>
<|im_start|>user
How are you?<|im_end|>
<|im_start|>assistant

clip_model_loader: model name:   Qwen2 VL 2B Instruct
clip_model_loader: description:
clip_model_loader: GGUF version: 3
clip_model_loader: alignment:    32
clip_model_loader: n_tensors:    520
clip_model_loader: n_kv:         27

clip_model_loader: has vision encoder
clip_ctx: CLIP using CPU backend
load_hparams: Qwen-VL models require at minimum 1024 image tokens to function correctly on grounding tasks
load_hparams: if you encounter problems with accuracy, try adding --image-min-tokens 1024
load_hparams: more info: https://github.com/ggml-org/llama.cpp/issues/16842

load_hparams: projector:          qwen2vl_merger
load_hparams: n_embd:             1280
load_hparams: n_head:             16
load_hparams: n_ff:               1536
load_hparams: n_layer:            32
load_hparams: ffn_op:             gelu_quick
load_hparams: projection_dim:     1536

--- vision hparams ---
load_hparams: image_size:         560
load_hparams: patch_size:         14
load_hparams: has_llava_proj:     0
load_hparams: minicpmv_version:   0
load_hparams: n_merge:            2
load_hparams: n_wa_pattern:       0
load_hparams: image_min_pixels:   6272
load_hparams: image_max_pixels:   3211264

load_hparams: model size:         1269.94 MiB
load_hparams: metadata size:      0.18 MiB
alloc_compute_meta: warmup with image size = 1288 x 1288
alloc_compute_meta:        CPU compute buffer size =   267.08 MiB
alloc_compute_meta: graph splits = 1, nodes = 1085
warmup: flash attention is enabled
main: loading model: ./Qwen2-VL-2B-Instruct/Qwen2-VL-2B-Instruct-Q5_K_M.gguf
encoding image slice...
image slice encoded in 11683 ms
decoding image batch 1/1, n_tokens_batch = 361
image decoded (batch 1/1) in 6250 ms

The image depicts a single rose placed on a marble surface, likely a table or a shelf. The rose is positioned in such a way that it is slightly tilted, with its petals facing upwards. The background features a dark, possibly stone or marble, wall with a textured surface, and a window or mirror reflecting the surroundings. The overall composition of the image creates a serene and elegant atmosphere.


llama_perf_context_print:        load time =     416.66 ms
llama_perf_context_print: prompt eval time =   18253.30 ms /   375 tokens (   48.68 ms per token,    20.54 tokens per second)
llama_perf_context_print:        eval time =    5283.83 ms /    78 runs   (   67.74 ms per token,    14.76 tokens per second)
llama_perf_context_print:       total time =   23892.18 ms /   453 tokens
llama_perf_context_print:    graphs reused =          0
```
